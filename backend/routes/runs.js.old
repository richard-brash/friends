import express from 'express';
import { authenticateToken, authorizeRoles } from '../src/middleware/auth.js';
import runService from '../services/runService.js';
const router = express.Router();

// Get all runs
router.get('/', authenticateToken, async (req, res) => {
  try {
    const runs = await runService.getAllRuns();
    res.json({ runs });
  } catch (error) {
    console.error('Error fetching runs:', error);
    res.status(500).json({ error: 'Failed to fetch runs' });
  }
});

// Get a specific run by ID
router.get('/:id', async (req, res) => {
  try {
    const run = await runService.getRunById(Number(req.params.id));
    if (!run) return res.status(404).json({ error: 'Run not found' });
    res.json({ run });
  } catch (error) {
    console.error('Error fetching run:', error);
    res.status(500).json({ error: 'Failed to fetch run' });
  }
});

// Create a new run
router.post('/', authenticateToken, authorizeRoles('admin', 'coordinator'), async (req, res) => {
  try {
    const run = await runService.createRun({
      status: 'scheduled',
      currentLocationIndex: 0,
      actualDuration: null,
      leadNotes: null,
      contactsMade: null,
      completedAt: null,
      ...req.body
    });
    res.status(201).json(run);
  } catch (error) {
    console.error('Error creating run:', error);
    res.status(500).json({ error: 'Failed to create run' });
  }
});

// Update a run
router.put('/:id', async (req, res) => {
  try {
    const run = await runService.updateRun(Number(req.params.id), req.body);
    if (!run) return res.status(404).json({ error: 'Run not found' });
    res.json(run);
  } catch (error) {
    console.error('Error updating run:', error);
    res.status(500).json({ error: 'Failed to update run' });
  }
});

// Assign users to a run
router.post('/:id/assign', async (req, res) => {
  try {
    const { userIds } = req.body;
    const runId = Number(req.params.id);
    
    // Add each user as a team member
    for (const userId of userIds) {
      await runService.addTeamMember(runId, userId);
    }
    
    const run = await runService.getRunById(runId);
    res.json(run);
  } catch (error) {
    console.error('Error assigning users to run:', error);
    res.status(500).json({ error: 'Failed to assign users' });
  }
});

// Remove users from a run  
router.post('/:id/unassign', async (req, res) => {
  try {
    const { userIds } = req.body;
    const runId = Number(req.params.id);
    
    // Remove each user from team members
    for (const userId of userIds) {
      await runService.removeTeamMember(runId, userId);
    }
    
    const run = await runService.getRunById(runId);
    res.json(run);
  } catch (error) {
    console.error('Error unassigning users from run:', error);
    res.status(500).json({ error: 'Failed to unassign users' });
  }
});

// Update run status and progress
router.patch('/:id/status', async (req, res) => {
  try {
    const { status, currentLocationIndex, leadNotes, contactsMade } = req.body;
    const runId = Number(req.params.id);
    
    const updates = { status };
    if (currentLocationIndex !== undefined) updates.currentLocationIndex = currentLocationIndex;
    if (leadNotes !== undefined) updates.leadNotes = leadNotes;
    if (contactsMade !== undefined) updates.contactsMade = contactsMade;
    
    if (status === 'completed') {
      updates.completedAt = new Date().toISOString();
    }
    
    const run = await runService.updateRun(runId, updates);
    if (!run) return res.status(404).json({ error: 'Run not found' });
    res.json(run);
  } catch (error) {
    console.error('Error updating run status:', error);
    res.status(500).json({ error: 'Failed to update run status' });
  }
});

// Delete a run
router.delete('/:id', async (req, res) => {
  try {
    await runService.deleteRun(Number(req.params.id));
    res.json({ message: 'Run deleted' });
  } catch (error) {
    console.error('Error deleting run:', error);
    res.status(500).json({ error: 'Failed to delete run' });
  }
});

export default router;
